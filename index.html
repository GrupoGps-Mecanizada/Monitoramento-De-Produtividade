<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Produtividade - GrupoGPS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-brand h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 0.9rem;
            color: #5a6c7d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .last-update-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .sync-dot.success { background: #27ae60; }
        .sync-dot.error { background: #e74c3c; }
        .sync-dot.loading { background: #f39c12; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Navigation */
        .nav-tabs {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0 2rem;
        }

        .nav-tabs-container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }

        .nav-tab {
            padding: 1.2rem 2rem;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            position: relative;
            background: transparent;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 8px 8px 0 0;
        }

        .nav-tab.active {
            color: #fff;
            border-bottom-color: transparent;
        }

        .nav-tab.active::before {
            opacity: 1;
        }

        .nav-tab > span {
            position: relative;
            z-index: 1;
        }

        .nav-tab:hover:not(.active) {
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.6);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .panel-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        .panel-content {
            padding: 2rem;
        }

        /* Filtros Modernos */
        .filter-toggle-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .filter-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .filter-panel {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 2rem;
            min-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .filter-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Timeline Container */
        .timeline-container {
            overflow: hidden;
            position: relative;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filter-container {
            position: relative;
        }

        #timeline {
            height: 600px;
            background: rgba(255, 255, 255, 0.8);
            position: relative;
        }

        /* Timeline Visual Improvements */
        .vis-timeline {
            border: none !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        .vis-panel.vis-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        .vis-labelset .vis-label {
            border-right: 1px solid rgba(255, 255, 255, 0.2) !important;
            background-color: rgba(255, 255, 255, 0.9) !important;
            color: #2c3e50 !important;
            font-weight: 600 !important;
            font-size: 13px !important;
        }

        .vis-time-axis .vis-text {
            color: #5a6c7d !important;
            font-weight: 600 !important;
        }

        .vis-item {
            border-radius: 6px !important;
            border-width: 2px !important;
            color: white !important;
            font-weight: 600 !important;
            font-size: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
        }

        .vis-item.vis-selected {
            border-width: 3px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25) !important;
        }

        /* Cores da Timeline - Status */
        .vis-item.status-running { 
            background-color: #27ae60 !important; 
            border-color: #219a52 !important; 
        }
        .vis-item.status-stopped { 
            background-color: #f1c40f !important; 
            border-color: #d4ac0d !important; 
        }
        .vis-item.status-off { 
            background-color: #95a5a6 !important; 
            border-color: #7f8c8d !important; 
        }
        .vis-item.status-maintenance { 
            background-color: #e67e22 !important; 
            border-color: #d35400 !important; 
        }
        .vis-item.status-out_of_plant { 
            background-color: #8b4513 !important; 
            border-color: #7a3c11 !important; 
        }
        .vis-item.status-not_appropriated { 
            background-color: #34495e !important; 
            border-color: #2c3e50 !important; 
        }
        .vis-item.status-no_data { 
            background-color: #2c3e50 !important; 
            border-color: #1a252f !important; 
        }
        .vis-item.status-on { 
            background-color: #3498db !important; 
            border-color: #2980b9 !important; 
        }
        .vis-item.status-secondary_motor_on { 
            background-color: #9b59b6 !important; 
            border-color: #8e44ad !important; 
        }

        /* Dashboard Stats Melhorado */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1rem;
            color: #5a6c7d;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stat-detail {
            font-size: 0.85rem;
            color: #7f8c8d;
            line-height: 1.4;
        }

        /* Real-time indicators */
        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .realtime-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid;
        }

        .realtime-card.critical { border-left-color: #e74c3c; }
        .realtime-card.warning { border-left-color: #f39c12; }
        .realtime-card.good { border-left-color: #27ae60; }
        .realtime-card.info { border-left-color: #3498db; }

        .realtime-title {
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .realtime-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .realtime-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chart-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Configuration Grid */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .config-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .config-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-item {
            margin-bottom: 1rem;
        }

        .config-item label {
            display: block;
            font-weight: 500;
            color: #5a6c7d;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .config-item input,
        .config-item select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .config-item input:focus,
        .config-item select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.95);
        }

        .config-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn.small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #5a6c7d;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            backdrop-filter: blur(20px);
        }

        .notification.success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .notification.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .notification.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .notification.info { background: linear-gradient(135deg, #3498db, #2980b9); }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <h1>Sistema de Produtividade - GrupoGPS</h1>
                </div>
                
                <div class="header-controls">
                    <div class="sync-indicator">
                        <div class="sync-dot loading" id="syncDot"></div>
                        <span id="syncStatus">Inicializando sistema...</span>
                    </div>
                    
                    <div class="last-update-info">
                        <span style="font-size: 0.85rem; color: #5a6c7d;">√öltima atualiza√ß√£o:</span>
                        <span id="lastUpdateTime" style="font-weight: 600; color: #2c3e50;">--:--</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <div class="nav-tabs-container">
                <div class="nav-tab active" data-tab="timeline">
                    <span>Timeline</span>
                </div>
                <div class="nav-tab" data-tab="dashboard">
                    <span>Dashboard</span>
                </div>
                <div class="nav-tab" data-tab="realtime">
                    <span>Tempo Real</span>
                </div>
                <div class="nav-tab" data-tab="alerts">
                    <span>Alertas</span>
                </div>
                <div class="nav-tab" data-tab="settings">
                    <span>Configura√ß√µes</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Timeline Tab -->
            <div id="timeline-tab" class="tab-content active">
                <div class="glass-panel timeline-container">
                    <div class="panel-header timeline-header">
                        <div class="panel-title">Timeline de Apontamentos e Status</div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span id="visibleItems">0 itens vis√≠veis</span>
                            <div class="filter-container">
                                <button class="filter-toggle-btn" id="filterToggleBtn">
                                    <span>üîç</span>
                                    Filtros Avan√ßados
                                </button>
                                <div class="filter-panel" id="filterPanel">
                                    <div style="margin-bottom: 1rem;">
                                        <label>Per√≠odo:</label>
                                        <select id="periodFilter" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 6px;">
                                            <option value="all">Todos os dados</option>
                                            <option value="today">Hoje</option>
                                            <option value="yesterday">Ontem</option>
                                            <option value="week" selected>√öltima semana</option>
                                            <option value="month">√öltimo m√™s</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label>Status:</label>
                                        <select id="statusFilter" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 6px;">
                                            <option value="">Todos os status</option>
                                            <option value="on">Motor Ligado</option>
                                            <option value="off">Motor Desligado</option>
                                            <option value="stopped">Parado</option>
                                            <option value="maintenance">Manuten√ß√£o</option>
                                            <option value="secondary_motor_on">Motor Secund√°rio</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label>Alertas:</label>
                                        <select id="alertFilter" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 6px;">
                                            <option value="">Todos</option>
                                            <option value="active">Apenas com Alertas</option>
                                            <option value="none">Sem Alertas</option>
                                        </select>
                                    </div>
                                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                        <button class="btn small secondary" id="clearFiltersBtn">Limpar</button>
                                        <button class="btn small" id="applyFiltersBtn">Aplicar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="timeline">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <div>Sincronizando dados do GitHub...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content">
                <!-- KPIs Principais -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="fleetProductivity">0%</div>
                        <div class="stat-label">Produtividade da Frota</div>
                        <div class="stat-detail" id="productivityDetail">Calculado com base no tempo efetivo de trabalho</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeAlerts">0</div>
                        <div class="stat-label">Alertas Ativos</div>
                        <div class="stat-detail" id="alertsDetail">Equipamentos com status irregular</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="productiveTime">0h</div>
                        <div class="stat-label">Tempo Produtivo</div>
                        <div class="stat-detail" id="productiveDetail">Trabalho efetivo realizado</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="operationalTime">0h</div>
                        <div class="stat-label">Tempo Operacional</div>
                        <div class="stat-detail" id="operationalDetail">Tr√¢nsito e deslocamentos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="idleTime">0h</div>
                        <div class="stat-label">Tempo Ocioso</div>
                        <div class="stat-detail" id="idleDetail">Oportunidades de melhoria</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="workingEquipments">0</div>
                        <div class="stat-label">Equipamentos Trabalhando</div>
                        <div class="stat-detail" id="workingDetail">Atualmente produtivos</div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="charts-container">
                    <div class="chart-panel">
                        <div class="chart-title">Distribui√ß√£o de Produtividade</div>
                        <div class="chart-container">
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <div class="chart-title">Status por Tipo de Equipamento</div>
                        <div class="chart-container">
                            <canvas id="equipmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Tab -->
            <div id="realtime-tab" class="tab-content">
                <div class="realtime-grid">
                    <div class="realtime-card critical">
                        <div class="realtime-title">
                            üö® Alertas Cr√≠ticos
                        </div>
                        <div class="realtime-list" id="criticalAlerts">
                            <div class="realtime-item">Nenhum alerta cr√≠tico</div>
                        </div>
                    </div>
                    
                    <div class="realtime-card warning">
                        <div class="realtime-title">
                            ‚ö†Ô∏è Equipamentos Ociosos
                        </div>
                        <div class="realtime-list" id="idleEquipments">
                            <div class="realtime-item">Carregando...</div>
                        </div>
                    </div>
                    
                    <div class="realtime-card good">
                        <div class="realtime-title">
                            ‚úÖ Equipamentos Produtivos
                        </div>
                        <div class="realtime-list" id="productiveEquipments">
                            <div class="realtime-item">Carregando...</div>
                        </div>
                    </div>
                    
                    <div class="realtime-card info">
                        <div class="realtime-title">
                            üîÑ Em Tr√¢nsito
                        </div>
                        <div class="realtime-list" id="transitEquipments">
                            <div class="realtime-item">Carregando...</div>
                        </div>
                    </div>
                </div>

                <!-- Performance Indicators -->
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title">Indicadores de Performance em Tempo Real</div>
                        <button class="btn small" id="refreshRealTimeBtn">üîÑ Atualizar</button>
                    </div>
                    <div class="panel-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.6); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;" id="avgProductivity">0%</div>
                                <div style="font-size: 0.9rem; color: #5a6c7d;">Produtividade M√©dia</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.6); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;" id="longestIdle">0min</div>
                                <div style="font-size: 0.9rem; color: #5a6c7d;">Maior Tempo Ocioso</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.6); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;" id="equipmentInTransit">0</div>
                                <div style="font-size: 0.9rem; color: #5a6c7d;">Em Deslocamento</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.6); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;" id="equipmentInMaintenance">0</div>
                                <div style="font-size: 0.9rem; color: #5a6c7d;">Em Manuten√ß√£o</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div id="alerts-tab" class="tab-content">
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title">Hist√≥rico de Alertas de Produtividade</div>
                        <button class="btn success small" id="exportAlertsBtn">üìä Exportar</button>
                    </div>
                    <div class="panel-content">
                        <div id="alertsList">
                            <div class="loading-state">
                                <div>Nenhum alerta registrado</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <!-- Configura√ß√µes de Produtividade -->
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title">Configura√ß√µes de Produtividade por Status</div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn secondary small" id="loadConfigBtn">üîÑ Sincronizar GitHub</button>
                            <button class="btn success small" id="saveConfigBtn">üíæ Salvar no GitHub</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="config-grid" id="productivityConfig">
                            <!-- Configura√ß√µes ser√£o inseridas dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√µes de Alertas -->
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title">Configura√ß√µes de Alertas por Status</div>
                        <button class="btn success small" id="saveAlertConfigBtn">üíæ Salvar Alertas</button>
                    </div>
                    <div class="panel-content">
                        <div class="config-grid" id="alertConfig">
                            <!-- Configura√ß√µes de alertas ser√£o inseridas dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas do Sistema -->
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title">Estat√≠sticas do Sistema</div>
                    </div>
                    <div class="panel-content">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="apontCount">0</div>
                                <div class="stat-label">Apontamentos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statusCount">0</div>
                                <div class="stat-label">Registros de Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="equipmentCount">0</div>
                                <div class="stat-label">Equipamentos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="consolidatedBlocks">0</div>
                                <div class="stat-label">Blocos Consolidados</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================================================
        // SISTEMA DE CONSOLIDA√á√ÉO DE BLOCOS INTEGRADO
        // =============================================================================
        class BlockConsolidationSystem {
            constructor() {
                this.config = {
                    gapTolerance: 60, // segundos - gap m√°ximo para consolidar
                    conflictResolution: 'priority' // priority, latest, longest
                };

                // Hierarquia de prioridade de status (maior n√∫mero = maior prioridade)
                this.statusPriority = {
                    'maintenance': 10,           // Manuten√ß√£o tem prioridade m√°xima
                    'out_of_plant': 9,          // Fora da planta
                    'secondary_motor_on': 8,    // Motor secund√°rio ligado
                    'on': 7,                    // Motor ligado
                    'running': 7,               // Motor rodando (alias para 'on')
                    'stopped': 6,               // Parado ligado
                    'off': 5,                   // Motor desligado
                    'not_appropriated': 4,      // N√£o apropriado
                    'no_data': 3               // Sem dados (menor prioridade)
                };

                this.consolidationStats = {
                    originalBlocks: 0,
                    consolidatedBlocks: 0,
                    conflictsResolved: 0,
                    duplicatesRemoved: 0
                };
            }

            // FUN√á√ÉO PRINCIPAL DE CONSOLIDA√á√ÉO
            processDataWithConsolidation(equipmentMap) {
                console.log('üîß Iniciando consolida√ß√£o de blocos...');
                
                // Reset estat√≠sticas
                this.consolidationStats = {
                    originalBlocks: 0,
                    consolidatedBlocks: 0,
                    conflictsResolved: 0,
                    duplicatesRemoved: 0
                };

                for (const [equipName, data] of equipmentMap) {
                    if (data.status && data.status.length > 0) {
                        console.log(`üìä Processando ${equipName}: ${data.status.length} registros originais`);
                        
                        // Aplicar consolida√ß√£o completa
                        data.status = this.consolidateStatusBlocks(data.status, equipName);
                        
                        console.log(`‚úÖ ${equipName}: ${data.status.length} registros ap√≥s consolida√ß√£o`);
                    }
                }

                this.logConsolidationResults();
                return equipmentMap;
            }

            // CONSOLIDA√á√ÉO COMPLETA DE STATUS
            consolidateStatusBlocks(statusList, equipmentName) {
                if (!statusList || statusList.length === 0) return [];

                console.log(`üîß Consolidando ${equipmentName}: ${statusList.length} registros`);
                this.consolidationStats.originalBlocks += statusList.length;

                // 1. Remover duplicatas exatas
                const uniqueStatus = this.removeDuplicates(statusList, equipmentName);
                
                // 2. Ordenar por tempo de in√≠cio
                const sortedStatus = uniqueStatus.sort((a, b) => 
                    new Date(a.start) - new Date(b.start)
                );

                // 3. Resolver sobreposi√ß√µes
                const resolvedStatus = this.resolveOverlaps(sortedStatus, equipmentName);

                // 4. Consolidar per√≠odos consecutivos do mesmo status
                const consolidatedStatus = this.consolidateConsecutive(resolvedStatus, equipmentName);

                // 5. Preencher gaps pequenos
                const finalStatus = this.fillSmallGaps(consolidatedStatus, equipmentName);

                this.consolidationStats.consolidatedBlocks += finalStatus.length;
                
                console.log(`üìà ${equipmentName}: ${statusList.length} ‚Üí ${finalStatus.length} blocos (${statusList.length - finalStatus.length} consolidados)`);
                
                return finalStatus;
            }

            // 1. REMO√á√ÉO DE DUPLICATAS EXATAS
            removeDuplicates(statusList, equipmentName) {
                const seen = new Set();
                const duplicatesRemoved = [];
                
                const unique = statusList.filter(status => {
                    // Criar chave √∫nica baseada em propriedades cr√≠ticas
                    const key = `${status.start}-${status.end}-${status.status}-${status.vacancy_code || ''}`;
                    
                    if (seen.has(key)) {
                        duplicatesRemoved.push(status);
                        return false;
                    }
                    
                    seen.add(key);
                    return true;
                });

                if (duplicatesRemoved.length > 0) {
                    console.log(`üóëÔ∏è ${equipmentName}: Removidas ${duplicatesRemoved.length} duplicatas exatas`);
                    this.consolidationStats.duplicatesRemoved += duplicatesRemoved.length;
                }

                return unique;
            }

            // 2. RESOLU√á√ÉO DE SOBREPOSI√á√ïES
            resolveOverlaps(statusList, equipmentName) {
                if (statusList.length <= 1) return statusList;

                const resolved = [];
                let current = null;

                for (const status of statusList) {
                    if (!current) {
                        current = { ...status };
                        continue;
                    }

                    const currentEnd = new Date(current.end);
                    const statusStart = new Date(status.start);

                    // Verificar se h√° sobreposi√ß√£o
                    if (statusStart < currentEnd) {
                        console.log(`‚ö†Ô∏è Sobreposi√ß√£o detectada em ${equipmentName}: ${current.status} vs ${status.status}`);
                        this.consolidationStats.conflictsResolved++;

                        // Resolver conflito baseado na prioridade
                        const priority1 = this.statusPriority[current.status] || 0;
                        const priority2 = this.statusPriority[status.status] || 0;

                        if (priority2 > priority1) {
                            current = { ...status };
                        } else {
                            current.end = status.end;
                            current.total_time = (parseFloat(current.total_time) || 0) + (parseFloat(status.total_time) || 0);
                        }
                    } else {
                        resolved.push(current);
                        current = { ...status };
                    }
                }

                if (current) {
                    resolved.push(current);
                }

                return resolved;
            }

            // 3. CONSOLIDA√á√ÉO DE PER√çODOS CONSECUTIVOS
            consolidateConsecutive(statusList, equipmentName) {
                if (statusList.length <= 1) return statusList;

                const consolidated = [];
                let current = null;
                let blocksConsolidated = 0;

                for (const status of statusList) {
                    if (!current) {
                        current = { ...status };
                        continue;
                    }

                    const currentEnd = new Date(current.end);
                    const statusStart = new Date(status.start);
                    const gapSeconds = (statusStart - currentEnd) / 1000;

                    // Verificar se pode consolidar
                    const canConsolidate = (
                        current.status === status.status && 
                        current.status_title === status.status_title &&
                        Math.abs(gapSeconds) <= this.config.gapTolerance
                    );

                    if (canConsolidate) {
                        // Consolidar: estender per√≠odo e somar tempo total
                        current.end = status.end;
                        current.total_time = (parseFloat(current.total_time) || 0) + (parseFloat(status.total_time) || 0);
                        current.consolidated_count = (current.consolidated_count || 1) + 1;
                        
                        blocksConsolidated++;
                        console.log(`üîó Consolidado: ${current.status} - ${current.consolidated_count} blocos unidos`);
                        
                    } else {
                        consolidated.push(current);
                        current = { ...status };
                    }
                }

                if (current) {
                    consolidated.push(current);
                }

                return consolidated;
            }

            // 4. PREENCHIMENTO DE GAPS PEQUENOS
            fillSmallGaps(statusList, equipmentName) {
                if (statusList.length <= 1) return statusList;

                const filled = [];
                let gapsFilled = 0;
                
                for (let i = 0; i < statusList.length; i++) {
                    filled.push(statusList[i]);
                    
                    // Verificar gap para o pr√≥ximo status
                    if (i < statusList.length - 1) {
                        const currentEnd = new Date(statusList[i].end);
                        const nextStart = new Date(statusList[i + 1].start);
                        const gapSeconds = (nextStart - currentEnd) / 1000;
                        
                        // Se gap pequeno, preencher com status 'off'
                        if (gapSeconds > 0 && gapSeconds <= this.config.gapTolerance) {
                            const gapBlock = {
                                ...statusList[i],
                                status: 'off',
                                status_title: 'Motor Desligado',
                                start: statusList[i].end,
                                end: statusList[i + 1].start,
                                total_time: gapSeconds / 3600,
                                gap_filled: true,
                                gap_duration_seconds: gapSeconds
                            };
                            
                            filled.push(gapBlock);
                            gapsFilled++;
                        }
                    }
                }

                if (gapsFilled > 0) {
                    console.log(`üîó ${equipmentName}: ${gapsFilled} gaps preenchidos`);
                }

                return filled;
            }

            // RELAT√ìRIO DE CONSOLIDA√á√ÉO
            logConsolidationResults() {
                const stats = this.consolidationStats;
                const totalReduction = stats.originalBlocks - stats.consolidatedBlocks;
                const reductionPercentage = stats.originalBlocks > 0 ? 
                    ((totalReduction / stats.originalBlocks) * 100).toFixed(1) : 0;

                console.log('üìä === RELAT√ìRIO DE CONSOLIDA√á√ÉO ===');
                console.log(`üì• Blocos Originais: ${stats.originalBlocks}`);
                console.log(`üì§ Blocos Finais: ${stats.consolidatedBlocks}`);
                console.log(`üîó Blocos Consolidados: ${totalReduction}`);
                console.log(`üìà Taxa de Redu√ß√£o: ${reductionPercentage}%`);
                console.log(`‚ö†Ô∏è Conflitos Resolvidos: ${stats.conflictsResolved}`);
                console.log(`üóëÔ∏è Duplicatas Removidas: ${stats.duplicatesRemoved}`);
                console.log('======================================');
            }

            // CRIA√á√ÉO DE TOOLTIP MELHORADO
            createConsolidatedTooltip(status, equipName) {
                const totalHours = parseFloat(status.total_time || 0);
                const count = status.consolidated_count || 1;
                const isGapFilled = status.gap_filled || false;
                
                const formatHours = (hours) => {
                    const h = Math.floor(hours);
                    const m = Math.round((hours - h) * 60);
                    if (h === 0) return `${m}min`;
                    if (m === 0) return `${h}h`;
                    return `${h}h ${m}min`;
                };

                const formatDateTime = (dateStr) => {
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };
                
                const shortEquipName = equipName.length > 25 ? equipName.substring(0, 25) + '...' : equipName;
                const statusTitle = (status.status_title || status.status);
                
                let tooltipContent = `
                    <div style="font-size: 12px; line-height: 1.3; max-width: 300px;">
                        <div style="font-weight: 700; margin-bottom: 6px; color: #fff; font-size: 11px;">
                            üîÑ Status ${isGapFilled ? '(Gap Preenchido)' : (count > 1 ? '(Consolidado)' : '')}
                        </div>
                        <div style="margin-bottom: 3px; font-size: 11px;"><strong>Equipamento:</strong><br>${shortEquipName}</div>
                        <div style="margin-bottom: 3px; font-size: 11px;"><strong>Status:</strong> ${statusTitle}</div>
                        <div style="margin-bottom: 3px; font-size: 11px;"><strong>In√≠cio:</strong><br>${formatDateTime(status.start)}</div>
                        <div style="margin-bottom: 3px; font-size: 11px;"><strong>Fim:</strong><br>${formatDateTime(status.end)}</div>
                        <div style="margin-bottom: 3px; font-size: 11px;"><strong>Dura√ß√£o:</strong> ${formatHours(totalHours)}</div>`;
                
                if (count > 1) {
                    tooltipContent += `
                        <div style="margin-bottom: 3px; color: #90EE90; font-size: 10px;">
                            <strong>‚úÖ Consolidado:</strong> ${count} blocos originais unidos
                        </div>`;
                }

                if (isGapFilled) {
                    tooltipContent += `
                        <div style="margin-bottom: 3px; color: #FFB347; font-size: 10px;">
                            <strong>‚ö†Ô∏è Gap Preenchido</strong>
                        </div>`;
                }
                
                tooltipContent += `</div>`;
                
                return tooltipContent;
            }
        }

        // =============================================================================
        // SISTEMA DE PRODUTIVIDADE PRINCIPAL CORRIGIDO
        // =============================================================================
        class ProductivitySystem {
            constructor() {
                this.timeline = null;
                this.items = new vis.DataSet();
                this.groups = new vis.DataSet();
                this.csvData = [];
                this.jsonData = [];
                this.equipmentMap = new Map();
                this.isUpdating = false;
                this.autoSyncInterval = null;
                this.alertCheckInterval = null;
                this.realTimeInterval = null;
                this.productivityChart = null;
                this.equipmentChart = null;
                
                // Sistema de Consolida√ß√£o INTEGRADO
                this.blockConsolidationSystem = new BlockConsolidationSystem();

                // Sistema de Alertas
                this.activeAlerts = new Map();
                this.alertHistory = [];

                // Configura√ß√µes do GitHub
                this.githubConfig = {
                    csvRepo: {
                        owner: 'GrupoGps-Mecanizada',
                        repo: 'Apontamento-Dos-Tablets',
                        path: 'data/apontamentos-atuais.csv',
                        apiUrl: 'https://api.github.com/repos/GrupoGps-Mecanizada/Apontamento-Dos-Tablets/contents/data/apontamentos-atuais.csv'
                    },
                    jsonRepo: {
                        owner: 'GrupoGps-Mecanizada',
                        repo: 'Controle-Status-Equipamentos-',
                        path: 'data/latest-fleet-data.json',
                        apiUrl: 'https://api.github.com/repos/GrupoGps-Mecanizada/Controle-Status-Equipamentos-/contents/data/latest-fleet-data.json'
                    },
                    configRepo: {
                        owner: 'GrupoGps-Mecanizada',
                        repo: 'Sistema-Produtividade-Config',
                        path: 'config/productivity-rules.json',
                        apiUrl: 'https://api.github.com/repos/GrupoGps-Mecanizada/Sistema-Produtividade-Config/contents/config/productivity-rules.json'
                    }
                };

                // Configura√ß√µes padr√£o de produtividade
                this.productivityRules = {
                    productive: {
                        'secondary_motor_on': {
                            equipments: ['alta_pressao', 'hiper_vacuo'],
                            description: 'Hidrojato Ativo - Trabalho Efetivo',
                            priority: 10
                        },
                        'stopped': {
                            equipments: ['auto_vacuo'],
                            description: 'Suc√ß√£o Ativa - Trabalho Efetivo',
                            priority: 9
                        }
                    },
                    operational: {
                        'on': {
                            equipments: ['all'],
                            description: 'Em Tr√¢nsito/Deslocamento',
                            priority: 7
                        },
                        'running': {
                            equipments: ['all'],
                            description: 'Em Movimento',
                            priority: 7
                        },
                        'out_of_plant': {
                            equipments: ['all'],
                            description: 'Deslocamento Externo',
                            priority: 6
                        }
                    },
                    idle: {
                        'off': {
                            equipments: ['all'],
                            description: 'Motor Desligado',
                            priority: 3,
                            alertLimit: 30
                        },
                        'stopped': {
                            equipments: ['alta_pressao'],
                            description: 'Parado (Ociosidade)',
                            priority: 4,
                            alertLimit: 45
                        },
                        'maintenance': {
                            equipments: ['all'],
                            description: 'Manuten√ß√£o Corretiva',
                            priority: 5,
                            alertLimit: 240
                        }
                    },
                    nonComputable: {
                        'not_appropriated': {
                            equipments: ['all'],
                            description: 'N√£o Apropriado (Fora do Regime)',
                            priority: 1
                        },
                        'no_data': {
                            equipments: ['all'],
                            description: 'Sem Dados (Falha de Sistema)',
                            priority: 2
                        }
                    }
                };

                this.alertConfig = {
                    off: { limit: 30, active: true, equipment: 'all' },
                    stopped: { limit: 45, active: true, equipment: 'alta_pressao' },
                    maintenance: { limit: 240, active: true, equipment: 'all' },
                    out_of_plant: { limit: 120, active: false, equipment: 'all' }
                };

                // Cores para timeline
                this.statusColors = {
                    'running': 'status-running',
                    'on': 'status-on',
                    'stopped': 'status-stopped',
                    'off': 'status-off',
                    'maintenance': 'status-maintenance',
                    'out_of_plant': 'status-out_of_plant',
                    'not_appropriated': 'status-not_appropriated',
                    'no_data': 'status-no_data',
                    'secondary_motor_on': 'status-secondary_motor_on'
                };

                this.initSystem();
            }

            // =============================================================================
            // INICIALIZA√á√ÉO CORRIGIDA
            // =============================================================================
            async initSystem() {
                console.log('üöÄ Sistema de Produtividade Avan√ßado - GrupoGPS iniciando...');
                this.updateSyncStatus('loading', 'Inicializando sistema...');
                
                this.setupEventListeners();
                this.initCharts();
                
                // Carregar configura√ß√µes do GitHub primeiro
                await this.loadConfigFromGitHub();
                
                this.buildConfigUI();
                this.updateSystemInfo();
                
                // Iniciar sincroniza√ß√£o autom√°tica
                await this.initGitHubSync();
                
                this.startAlertMonitoring();
                this.startRealTimeMonitoring();
                
                console.log('‚úÖ Sistema inicializado com sucesso');
            }

            // =============================================================================
            // SINCRONIZA√á√ÉO AUTOM√ÅTICA COM GITHUB
            // =============================================================================
            async initGitHubSync() {
                console.log('üîÑ Iniciando sincroniza√ß√£o GitHub...');
                this.updateSyncStatus('loading', 'Sincronizando com GitHub...');
                
                try {
                    // Primeira sincroniza√ß√£o
                    await this.syncFromGitHub();
                    
                    // Configurar sincroniza√ß√£o autom√°tica a cada 5 minutos
                    this.autoSyncInterval = setInterval(async () => {
                        try {
                            await this.syncFromGitHub();
                        } catch (error) {
                            console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', error);
                        }
                    }, 300000); // 5 minutos
                    
                    console.log('‚úÖ Sincroniza√ß√£o autom√°tica configurada');
                    
                } catch (error) {
                    console.error('‚ùå Erro na sincroniza√ß√£o inicial:', error);
                    this.updateSyncStatus('error', 'Erro na sincroniza√ß√£o inicial');
                }
            }

            async syncFromGitHub() {
                let csvLoaded = false;
                let jsonLoaded = false;
                
                try {
                    // Carregar CSV
                    try {
                        const csvResponse = await fetch(this.githubConfig.csvRepo.apiUrl);
                        if (csvResponse.ok) {
                            const csvData = await csvResponse.json();
                            const csvContent = atob(csvData.content.replace(/\n/g, ''));
                            await this.processCsvData(csvContent);
                            csvLoaded = true;
                            console.log('‚úÖ Dados CSV sincronizados do GitHub');
                        } else {
                            console.log('‚ö†Ô∏è CSV n√£o encontrado no GitHub (404)');
                        }
                    } catch (error) {
                        console.log('‚ö†Ô∏è Erro ao carregar CSV:', error.message);
                    }

                    // Carregar JSON
                    try {
                        const jsonResponse = await fetch(this.githubConfig.jsonRepo.apiUrl);
                        if (jsonResponse.ok) {
                            const jsonData = await jsonResponse.json();
                            const jsonContent = atob(jsonData.content.replace(/\n/g, ''));
                            await this.processJsonData(jsonContent);
                            jsonLoaded = true;
                            console.log('‚úÖ Dados JSON sincronizados do GitHub');
                        } else {
                            console.log('‚ö†Ô∏è JSON n√£o encontrado no GitHub (404)');
                        }
                    } catch (error) {
                        console.log('‚ö†Ô∏è Erro ao carregar JSON:', error.message);
                    }

                    // Se pelo menos um arquivo foi carregado, processar dados
                    if (csvLoaded || jsonLoaded) {
                        console.log('üîß Aplicando consolida√ß√£o de blocos...');
                        this.equipmentMap = this.blockConsolidationSystem.processDataWithConsolidation(this.equipmentMap);
                        await this.processAllData();
                        this.updateSyncStatus('success', 'Dados sincronizados com sucesso');
                        this.showNotification('Dados sincronizados do GitHub!', 'success');
                    } else {
                        this.updateSyncStatus('error', 'Nenhum dado encontrado no GitHub');
                        this.showNotification('Nenhum dado encontrado nos reposit√≥rios GitHub', 'warning');
                    }

                } catch (error) {
                    console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                    this.updateSyncStatus('error', 'Erro na sincroniza√ß√£o');
                    throw error;
                }
            }

            // =============================================================================
            // CONFIGURA√á√ïES EXTERNAS DO GITHUB CORRIGIDAS
            // =============================================================================
            async loadConfigFromGitHub() {
                try {
                    console.log('üì• Carregando configura√ß√µes do GitHub...');
                    
                    const response = await fetch(this.githubConfig.configRepo.apiUrl);
                    if (response.ok) {
                        const apiData = await response.json();
                        let configText = atob(apiData.content.replace(/\n/g, ''));
                        
                        try {
                            configText = decodeURIComponent(escape(configText));
                        } catch (error) {
                            console.log('Usando texto original');
                        }
                        
                        const config = JSON.parse(configText);
                        
                        // Atualizar regras de produtividade
                        if (config.productivityRules) {
                            this.productivityRules = { ...this.productivityRules, ...config.productivityRules };
                        }
                        
                        // Atualizar configura√ß√µes de alerta
                        if (config.alertConfig) {
                            this.alertConfig = { ...this.alertConfig, ...config.alertConfig };
                        }
                        
                        console.log('‚úÖ Configura√ß√µes carregadas do GitHub com sucesso');
                        this.showNotification('Configura√ß√µes sincronizadas do GitHub', 'success');
                        
                    } else if (response.status === 404) {
                        console.log('‚ö†Ô∏è Arquivo de configura√ß√£o n√£o encontrado no GitHub, criando padr√£o...');
                        await this.createDefaultConfigOnGitHub();
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar configura√ß√µes do GitHub:', error);
                    console.log('üìù Usando configura√ß√µes padr√£o locais');
                    this.showNotification('Usando configura√ß√µes padr√£o locais', 'warning');
                }
            }

            async createDefaultConfigOnGitHub() {
                try {
                    console.log('üìù Criando configura√ß√µes padr√£o...');
                    
                    const defaultConfig = {
                        productivityRules: this.productivityRules,
                        alertConfig: this.alertConfig,
                        lastUpdate: new Date().toISOString(),
                        version: '1.0.0',
                        description: 'Configura√ß√µes padr√£o do Sistema de Produtividade GrupoGPS'
                    };
                    
                    console.log('üíæ Configura√ß√µes padr√£o criadas localmente:', defaultConfig);
                    this.showNotification('Configura√ß√µes padr√£o criadas com sucesso', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao criar configura√ß√£o padr√£o:', error);
                    this.showNotification('Erro ao criar configura√ß√µes padr√£o', 'error');
                }
            }

            // =============================================================================
            // EVENT LISTENERS CORRIGIDOS
            // =============================================================================
            setupEventListeners() {
                // Navega√ß√£o por abas - CORRIGIDO
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.getAttribute('data-tab');
                        this.switchTab(tabName);
                    });
                });

                // Filtros
                const filterToggleBtn = document.getElementById('filterToggleBtn');
                if (filterToggleBtn) {
                    filterToggleBtn.addEventListener('click', () => this.toggleFilterPanel());
                }

                const clearFiltersBtn = document.getElementById('clearFiltersBtn');
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', () => this.clearFilters());
                }

                const applyFiltersBtn = document.getElementById('applyFiltersBtn');
                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', () => this.applyFilters());
                }

                // Real-time
                const refreshRealTimeBtn = document.getElementById('refreshRealTimeBtn');
                if (refreshRealTimeBtn) {
                    refreshRealTimeBtn.addEventListener('click', () => this.refreshRealTime());
                }

                // Configura√ß√µes
                const loadConfigBtn = document.getElementById('loadConfigBtn');
                if (loadConfigBtn) {
                    loadConfigBtn.addEventListener('click', () => this.loadConfigFromGitHub());
                }

                const saveConfigBtn = document.getElementById('saveConfigBtn');
                if (saveConfigBtn) {
                    saveConfigBtn.addEventListener('click', () => this.saveConfigToGitHub());
                }

                const saveAlertConfigBtn = document.getElementById('saveAlertConfigBtn');
                if (saveAlertConfigBtn) {
                    saveAlertConfigBtn.addEventListener('click', () => this.saveAlertConfig());
                }

                // Exportar alertas
                const exportAlertsBtn = document.getElementById('exportAlertsBtn');
                if (exportAlertsBtn) {
                    exportAlertsBtn.addEventListener('click', () => this.exportAlerts());
                }

                // Filtros de per√≠odo/status
                const periodFilter = document.getElementById('periodFilter');
                if (periodFilter) {
                    periodFilter.addEventListener('change', () => this.applyFilters());
                }
                
                const statusFilter = document.getElementById('statusFilter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', () => this.applyFilters());
                }
                
                const alertFilter = document.getElementById('alertFilter');
                if (alertFilter) {
                    alertFilter.addEventListener('change', () => this.applyFilters());
                }
            }

            // Fun√ß√£o de navega√ß√£o por abas - CORRIGIDA
            switchTab(tabName) {
                // Remover classe active de todas as abas
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Adicionar classe active √† aba selecionada
                const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }
                
                const selectedContent = document.getElementById(`${tabName}-tab`);
                if (selectedContent) {
                    selectedContent.classList.add('active');
                }
            }

            toggleFilterPanel() {
                const panel = document.getElementById('filterPanel');
                if (panel) {
                    panel.classList.toggle('show');
                }
            }

            clearFilters() {
                const periodFilter = document.getElementById('periodFilter');
                const statusFilter = document.getElementById('statusFilter');
                const alertFilter = document.getElementById('alertFilter');
                
                if (periodFilter) periodFilter.value = 'week';
                if (statusFilter) statusFilter.value = '';
                if (alertFilter) alertFilter.value = '';
                
                this.applyFilters();
            }

            applyFilters() {
                console.log('üîç Aplicando filtros...');
                // Implementar l√≥gica de filtros na timeline
                this.showNotification('Filtros aplicados', 'info');
                this.toggleFilterPanel();
            }

            refreshRealTime() {
                this.updateRealTimeData();
                this.showNotification('Dados em tempo real atualizados!', 'success');
            }

            // =============================================================================
            // PROCESSAMENTO DE DADOS
            // =============================================================================
            async processCsvData(csvText) {
                console.log('üìÑ Processando dados CSV...');
                
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                this.csvData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    if (values.length === headers.length) {
                        const record = {};
                        headers.forEach((header, index) => {
                            record[header] = values[index];
                        });
                        this.csvData.push(record);
                    }
                }
                
                console.log(`‚úÖ ${this.csvData.length} registros CSV processados`);
            }

            async processJsonData(jsonText) {
                console.log('üìÑ Processando dados JSON...');
                
                try {
                    this.jsonData = JSON.parse(jsonText);
                    if (!Array.isArray(this.jsonData)) {
                        this.jsonData = [this.jsonData];
                    }
                    console.log(`‚úÖ ${this.jsonData.length} registros JSON processados`);
                } catch (error) {
                    console.error('‚ùå Erro ao parsear JSON:', error);
                    throw error;
                }
            }

            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                values.push(current.trim());
                return values.map(v => v.replace(/"/g, ''));
            }

            // =============================================================================
            // PROCESSAMENTO COMPLETO DOS DADOS
            // =============================================================================
            async processAllData() {
                console.log('üîÑ Processando todos os dados...');
                
                // Construir mapa de equipamentos
                this.buildEquipmentMap();
                
                // Atualizar timeline
                this.updateTimeline();
                
                // Atualizar dashboard
                this.updateDashboard();
                
                // Atualizar estat√≠sticas
                this.updateStats();
                
                console.log('‚úÖ Processamento completo finalizado');
            }

            buildEquipmentMap() {
                // Processar dados JSON (status dos equipamentos)
                if (this.jsonData.length > 0) {
                    for (const item of this.jsonData) {
                        if (item.equipments) {
                            for (const [equipName, equipData] of Object.entries(item.equipments)) {
                                const normalizedName = this.normalizeEquipmentName(equipName);
                                
                                if (!this.equipmentMap.has(normalizedName)) {
                                    this.equipmentMap.set(normalizedName, {
                                        name: normalizedName,
                                        status: [],
                                        apontamentos: []
                                    });
                                }
                                
                                const equipment = this.equipmentMap.get(normalizedName);
                                if (equipData.status) {
                                    equipment.status.push(...equipData.status);
                                }
                            }
                        }
                    }
                }
                
                // Processar dados CSV (apontamentos)
                if (this.csvData.length > 0) {
                    for (const record of this.csvData) {
                        const equipName = this.normalizeEquipmentName(record['EQUIPAMENTO'] || record['equipamento'] || '');
                        
                        if (equipName && equipName !== 'EQUIPAMENTO DESCONHECIDO') {
                            if (!this.equipmentMap.has(equipName)) {
                                this.equipmentMap.set(equipName, {
                                    name: equipName,
                                    status: [],
                                    apontamentos: []
                                });
                            }
                            
                            const equipment = this.equipmentMap.get(equipName);
                            equipment.apontamentos.push(record);
                        }
                    }
                }
                
                console.log(`üèóÔ∏è Mapa de equipamentos constru√≠do: ${this.equipmentMap.size} equipamentos`);
            }

            // =============================================================================
            // TIMELINE E INTERFACE
            // =============================================================================
            updateTimeline() {
                console.log('üìä Atualizando timeline...');
                
                if (!this.timeline) {
                    this.initTimeline();
                }
                
                this.items.clear();
                this.groups.clear();
                
                let itemId = 1;
                const groupsMap = new Map();
                
                for (const [equipName, data] of this.equipmentMap) {
                    // Adicionar grupo se n√£o existir
                    if (!groupsMap.has(equipName)) {
                        const groupId = groupsMap.size + 1;
                        groupsMap.set(equipName, groupId);
                        this.groups.add({
                            id: groupId,
                            content: this.getDisplayName(equipName),
                            order: groupId
                        });
                    }
                    
                    const groupId = groupsMap.get(equipName);
                    
                    // Adicionar status consolidados
                    for (const status of data.status) {
                        this.items.add({
                            id: itemId++,
                            group: groupId,
                            start: new Date(status.start),
                            end: new Date(status.end),
                            content: this.getStatusDisplayName(status.status),
                            title: this.blockConsolidationSystem.createConsolidatedTooltip(status, equipName),
                            className: this.statusColors[status.status] || 'status-unknown',
                            type: 'range'
                        });
                    }
                    
                    // Adicionar apontamentos
                    for (const apont of data.apontamentos) {
                        const startDate = this.parseDate(apont['DATA INICIO'] || apont['data_inicio']);
                        const endDate = this.parseDate(apont['DATA FIM'] || apont['data_fim']);
                        
                        if (startDate && endDate) {
                            this.items.add({
                                id: itemId++,
                                group: groupId,
                                start: startDate,
                                end: endDate,
                                content: apont['ATIVIDADE'] || apont['atividade'] || 'Atividade',
                                title: `Apontamento: ${apont['ATIVIDADE'] || 'Atividade'}\nIn√≠cio: ${startDate.toLocaleString()}\nFim: ${endDate.toLocaleString()}`,
                                className: 'apontamento-item',
                                type: 'range',
                                style: 'background-color: rgba(52, 152, 219, 0.7); border-color: #3498db;'
                            });
                        }
                    }
                }
                
                // Atualizar contador de itens vis√≠veis
                document.getElementById('visibleItems').textContent = `${this.items.length} itens vis√≠veis`;
                
                console.log(`‚úÖ Timeline atualizada: ${this.items.length} itens, ${this.groups.length} grupos`);
            }

            initTimeline() {
                const container = document.getElementById('timeline');
                container.innerHTML = '';
                
                const options = {
                    height: '600px',
                    margin: { item: 10, axis: 40 },
                    orientation: 'top',
                    stack: true,
                    showCurrentTime: true,
                    zoomable: true,
                    moveable: true,
                    selectable: true,
                    multiselect: false,
                    tooltip: {
                        followMouse: true,
                        overflowMethod: 'cap'
                    },
                    format: {
                        minorLabels: {
                            hour: 'HH:mm',
                            day: 'DD/MM'
                        },
                        majorLabels: {
                            hour: 'DD/MM/YYYY',
                            day: 'MMMM YYYY'
                        }
                    }
                };
                
                this.timeline = new vis.Timeline(container, this.items, this.groups, options);
                
                // Event listeners
                this.timeline.on('select', (properties) => {
                    console.log('Item selecionado:', properties);
                });
            }

            // =============================================================================
            // CHARTS E DASHBOARD IMPLEMENTADOS
            // =============================================================================
            initCharts() {
                // Gr√°fico de Produtividade
                const productivityCtx = document.getElementById('productivityChart');
                if (productivityCtx) {
                    this.productivityChart = new Chart(productivityCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Produtivo', 'Operacional', 'Ocioso'],
                            datasets: [{
                                data: [0, 0, 0],
                                backgroundColor: ['#27ae60', '#3498db', '#e74c3c'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }

                // Gr√°fico por Tipo de Equipamento
                const equipmentCtx = document.getElementById('equipmentChart');
                if (equipmentCtx) {
                    this.equipmentChart = new Chart(equipmentCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Alta Press√£o', 'Auto V√°cuo', 'Hiper V√°cuo'],
                            datasets: [
                                {
                                    label: 'Produtivo',
                                    data: [0, 0, 0],
                                    backgroundColor: '#27ae60'
                                },
                                {
                                    label: 'Operacional',
                                    data: [0, 0, 0],
                                    backgroundColor: '#3498db'
                                },
                                {
                                    label: 'Ocioso',
                                    data: [0, 0, 0],
                                    backgroundColor: '#e74c3c'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true
                                }
                            }
                        }
                    });
                }
            }

            updateDashboard() {
                if (!this.equipmentMap.size) return;

                console.log('üìà Atualizando dashboard...');

                const stats = this.calculateProductivityStats();
                
                // Atualizar KPIs principais
                document.getElementById('fleetProductivity').textContent = stats.fleetProductivity + '%';
                document.getElementById('activeAlerts').textContent = this.activeAlerts.size;
                document.getElementById('productiveTime').textContent = this.formatHours(stats.productiveTime);
                document.getElementById('operationalTime').textContent = this.formatHours(stats.operationalTime);
                document.getElementById('idleTime').textContent = this.formatHours(stats.idleTime);
                document.getElementById('workingEquipments').textContent = stats.workingEquipments;

                // Atualizar detalhes
                document.getElementById('productivityDetail').textContent = `${stats.productiveEquipments} equipamentos produtivos`;
                document.getElementById('alertsDetail').textContent = `${this.activeAlerts.size} equipamentos com alertas`;
                document.getElementById('productiveDetail').textContent = `${Math.round(stats.productivityPercentage)}% do tempo total`;
                document.getElementById('operationalDetail').textContent = `${Math.round(stats.operationalPercentage)}% do tempo total`;
                document.getElementById('idleDetail').textContent = `${Math.round(stats.idlePercentage)}% do tempo total`;
                document.getElementById('workingDetail').textContent = `De ${stats.totalEquipments} equipamentos`;

                // Atualizar gr√°ficos
                if (this.productivityChart) {
                    this.productivityChart.data.datasets[0].data = [
                        stats.productiveTime,
                        stats.operationalTime,
                        stats.idleTime
                    ];
                    this.productivityChart.update();
                }

                if (this.equipmentChart) {
                    this.equipmentChart.data.datasets[0].data = [
                        stats.byType.alta_pressao.productive,
                        stats.byType.auto_vacuo.productive,
                        stats.byType.hiper_vacuo.productive
                    ];
                    this.equipmentChart.data.datasets[1].data = [
                        stats.byType.alta_pressao.operational,
                        stats.byType.auto_vacuo.operational,
                        stats.byType.hiper_vacuo.operational
                    ];
                    this.equipmentChart.data.datasets[2].data = [
                        stats.byType.alta_pressao.idle,
                        stats.byType.auto_vacuo.idle,
                        stats.byType.hiper_vacuo.idle
                    ];
                    this.equipmentChart.update();
                }
            }

            calculateProductivityStats() {
                const stats = {
                    totalEquipments: this.equipmentMap.size,
                    productiveEquipments: 0,
                    workingEquipments: 0,
                    productiveTime: 0,
                    operationalTime: 0,
                    idleTime: 0,
                    totalTime: 0,
                    fleetProductivity: 0,
                    productivityPercentage: 0,
                    operationalPercentage: 0,
                    idlePercentage: 0,
                    byType: {
                        alta_pressao: { productive: 0, operational: 0, idle: 0 },
                        auto_vacuo: { productive: 0, operational: 0, idle: 0 },
                        hiper_vacuo: { productive: 0, operational: 0, idle: 0 }
                    }
                };

                const now = new Date();

                for (const [equipName, data] of this.equipmentMap) {
                    const equipmentType = this.getEquipmentType(equipName);
                    const workingPeriodStatus = this.getWorkingPeriodStatus(data.status);
                    
                    let equipProductiveTime = 0;
                    let equipOperationalTime = 0;
                    let equipIdleTime = 0;

                    // Calcular tempos por classifica√ß√£o
                    for (const status of workingPeriodStatus) {
                        const classification = this.classifyStatusExact(status.status, equipmentType);
                        const duration = parseFloat(status.total_time || 0);

                        switch (classification) {
                            case 'PRODUCTIVE':
                                equipProductiveTime += duration;
                                break;
                            case 'OPERATIONAL':
                                equipOperationalTime += duration;
                                break;
                            case 'IDLE':
                                equipIdleTime += duration;
                                break;
                        }
                    }

                    // Verificar se equipamento est√° trabalhando atualmente
                    const currentStatus = this.findCurrentActiveStatus(workingPeriodStatus, now);
                    if (currentStatus) {
                        const classification = this.classifyStatusExact(currentStatus.status, equipmentType);
                        if (classification === 'PRODUCTIVE') {
                            stats.productiveEquipments++;
                        }
                        if (classification === 'PRODUCTIVE' || classification === 'OPERATIONAL') {
                            stats.workingEquipments++;
                        }
                    }

                    // Acumular totais
                    stats.productiveTime += equipProductiveTime;
                    stats.operationalTime += equipOperationalTime;
                    stats.idleTime += equipIdleTime;

                    // Acumular por tipo
                    const typeKey = equipmentType === 'all' ? 'alta_pressao' : equipmentType;
                    if (stats.byType[typeKey]) {
                        stats.byType[typeKey].productive += equipProductiveTime;
                        stats.byType[typeKey].operational += equipOperationalTime;
                        stats.byType[typeKey].idle += equipIdleTime;
                    }
                }

                stats.totalTime = stats.productiveTime + stats.operationalTime + stats.idleTime;

                if (stats.totalTime > 0) {
                    stats.productivityPercentage = (stats.productiveTime / stats.totalTime) * 100;
                    stats.operationalPercentage = (stats.operationalTime / stats.totalTime) * 100;
                    stats.idlePercentage = (stats.idleTime / stats.totalTime) * 100;
                    stats.fleetProductivity = Math.round(stats.productivityPercentage + (stats.operationalPercentage * 0.6));
                }

                return stats;
            }

            updateStats() {
                // Atualizar estat√≠sticas do sistema
                const totalApontamentos = Array.from(this.equipmentMap.values())
                    .reduce((sum, data) => sum + (data.apontamentos?.length || 0), 0);
                
                const totalStatus = Array.from(this.equipmentMap.values())
                    .reduce((sum, data) => sum + (data.status?.length || 0), 0);

                document.getElementById('apontCount').textContent = totalApontamentos;
                document.getElementById('statusCount').textContent = totalStatus;
                document.getElementById('equipmentCount').textContent = this.equipmentMap.size;
                document.getElementById('consolidatedBlocks').textContent = 
                    this.blockConsolidationSystem.consolidationStats.originalBlocks - 
                    this.blockConsolidationSystem.consolidationStats.consolidatedBlocks;
            }

            // =============================================================================
            // MONITORAMENTO DE ALERTAS
            // =============================================================================
            startAlertMonitoring() {
                if (this.alertCheckInterval) {
                    clearInterval(this.alertCheckInterval);
                }

                // Verificar alertas a cada 30 segundos
                this.alertCheckInterval = setInterval(() => {
                    this.checkAlerts();
                }, 30000);

                console.log('üö® Monitoramento de alertas iniciado');
            }

            checkAlerts() {
                if (!this.equipmentMap.size) return;

                const now = new Date();
                let newAlerts = 0;

                for (const [equipName, data] of this.equipmentMap) {
                    const equipmentType = this.getEquipmentType(equipName);
                    const workingPeriodStatus = this.getWorkingPeriodStatus(data.status);
                    const currentStatus = this.findCurrentActiveStatus(workingPeriodStatus, now);
                    
                    if (currentStatus) {
                        const duration = this.calculateCurrentStatusDuration(currentStatus, now);
                        const alertKey = `${equipName}_${currentStatus.status}`;
                        
                        // Verificar se deve gerar alerta
                        const alertConfig = this.alertConfig[currentStatus.status];
                        if (alertConfig && alertConfig.active && duration >= alertConfig.limit) {
                            
                            if (!this.activeAlerts.has(alertKey)) {
                                // Novo alerta
                                const alert = {
                                    id: Date.now(),
                                    equipName,
                                    status: currentStatus.status,
                                    duration,
                                    timestamp: now,
                                    type: this.getAlertType(currentStatus.status)
                                };
                                
                                this.activeAlerts.set(alertKey, alert);
                                this.alertHistory.push(alert);
                                newAlerts++;
                                
                                console.log(`üö® Novo alerta: ${equipName} em ${currentStatus.status} por ${duration}min`);
                            } else {
                                // Atualizar dura√ß√£o do alerta existente
                                this.activeAlerts.get(alertKey).duration = duration;
                            }
                        } else {
                            // Remover alerta se condi√ß√µes n√£o s√£o mais atendidas
                            if (this.activeAlerts.has(alertKey)) {
                                this.activeAlerts.delete(alertKey);
                                console.log(`‚úÖ Alerta resolvido: ${equipName}`);
                            }
                        }
                    }
                }

                if (newAlerts > 0) {
                    this.showNotification(`${newAlerts} novo(s) alerta(s) detectado(s)`, 'warning');
                    this.updateAlertsList();
                }
            }

            getAlertType(status) {
                const criticalStatuses = ['maintenance', 'off'];
                return criticalStatuses.includes(status) ? 'critical' : 'warning';
            }

            updateAlertsList() {
                const container = document.getElementById('alertsList');
                if (!container) return;

                if (this.alertHistory.length === 0) {
                    container.innerHTML = '<div class="loading-state"><div>Nenhum alerta registrado</div></div>';
                    return;
                }

                const alertsHtml = this.alertHistory
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 50) // √öltimos 50 alertas
                    .map(alert => `
                        <div class="realtime-item" style="margin-bottom: 0.5rem; padding: 1rem; border-left: 4px solid ${alert.type === 'critical' ? '#e74c3c' : '#f39c12'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${this.getDisplayName(alert.equipName)}</strong><br>
                                    <span style="color: #7f8c8d;">${this.getStatusDisplayName(alert.status)} por ${alert.duration}min</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #95a5a6;">
                                    ${alert.timestamp.toLocaleString('pt-BR')}
                                </div>
                            </div>
                        </div>
                    `).join('');

                container.innerHTML = alertsHtml;
            }

            // =============================================================================
            // MONITORAMENTO EM TEMPO REAL
            // =============================================================================
            startRealTimeMonitoring() {
                if (this.realTimeInterval) {
                    clearInterval(this.realTimeInterval);
                }

                // Atualizar a cada 30 segundos
                this.realTimeInterval = setInterval(() => {
                    this.updateRealTimeData();
                }, 30000);

                console.log('‚ö° Monitoramento em tempo real iniciado');
            }

            updateRealTimeData() {
                if (!this.equipmentMap.size) return;

                const realTimeData = {
                    criticalAlerts: [],
                    idleEquipments: [],
                    productiveEquipments: [],
                    transitEquipments: [],
                    avgProductivity: 0,
                    longestIdle: 0,
                    equipmentInTransit: 0,
                    equipmentInMaintenance: 0
                };

                const now = new Date();
                let totalProductivity = 0;
                let equipmentCount = 0;

                for (const [equipName, data] of this.equipmentMap) {
                    const equipmentType = this.getEquipmentType(equipName);
                    const workingPeriodStatus = this.getWorkingPeriodStatus(data.status);
                    const currentStatus = this.findCurrentActiveStatus(workingPeriodStatus, now);
                    
                    if (currentStatus) {
                        const duration = this.calculateCurrentStatusDuration(currentStatus, now);
                        const classification = this.classifyStatusExact(currentStatus.status, equipmentType);
                        const displayName = this.getDisplayName(equipName);

                        const equipment = {
                            name: displayName,
                            status: currentStatus.status,
                            duration: duration,
                            classification: classification
                        };

                        switch (classification) {
                            case 'PRODUCTIVE':
                                realTimeData.productiveEquipments.push(equipment);
                                totalProductivity += 100;
                                break;
                            case 'OPERATIONAL':
                                realTimeData.transitEquipments.push(equipment);
                                realTimeData.equipmentInTransit++;
                                totalProductivity += 60;
                                break;
                            case 'IDLE':
                                realTimeData.idleEquipments.push(equipment);
                                if (duration > realTimeData.longestIdle) {
                                    realTimeData.longestIdle = duration;
                                }
                                if (currentStatus.status === 'maintenance') {
                                    realTimeData.equipmentInMaintenance++;
                                }
                                break;
                        }

                        // Verificar alertas cr√≠ticos
                        const alertKey = `${equipName}_${currentStatus.status}`;
                        if (this.activeAlerts.has(alertKey)) {
                            realTimeData.criticalAlerts.push({
                                ...equipment,
                                alertDuration: this.activeAlerts.get(alertKey).duration
                            });
                        }

                        equipmentCount++;
                    }
                }

                realTimeData.avgProductivity = equipmentCount > 0 ? Math.round(totalProductivity / equipmentCount) : 0;

                this.renderRealTimeData(realTimeData);
            }

            renderRealTimeData(data) {
                // Alertas Cr√≠ticos
                const criticalContainer = document.getElementById('criticalAlerts');
                if (criticalContainer) {
                    criticalContainer.innerHTML = data.criticalAlerts.length === 0 
                        ? '<div class="realtime-item">Nenhum alerta cr√≠tico üéâ</div>'
                        : data.criticalAlerts.map(alert => `
                            <div class="realtime-item">
                                <span>${alert.name}</span>
                                <span>${alert.alertDuration}min em ${this.getStatusDisplayName(alert.status)}</span>
                            </div>
                        `).join('');
                }

                // Equipamentos Ociosos
                const idleContainer = document.getElementById('idleEquipments');
                if (idleContainer) {
                    idleContainer.innerHTML = data.idleEquipments.length === 0
                        ? '<div class="realtime-item">Todos equipamentos ativos üéâ</div>'
                        : data.idleEquipments.slice(0, 5).map(equip => `
                            <div class="realtime-item">
                                <span>${equip.name}</span>
                                <span>${equip.duration}min ${this.getStatusDisplayName(equip.status)}</span>
                            </div>
                        `).join('');
                }

                // Equipamentos Produtivos
                const productiveContainer = document.getElementById('productiveEquipments');
                if (productiveContainer) {
                    productiveContainer.innerHTML = data.productiveEquipments.length === 0
                        ? '<div class="realtime-item">Nenhum equipamento produtivo</div>'
                        : data.productiveEquipments.slice(0, 5).map(equip => `
                            <div class="realtime-item">
                                <span>${equip.name}</span>
                                <span>${equip.duration}min trabalhando</span>
                            </div>
                        `).join('');
                }

                // Em Tr√¢nsito
                const transitContainer = document.getElementById('transitEquipments');
                if (transitContainer) {
                    transitContainer.innerHTML = data.transitEquipments.length === 0
                        ? '<div class="realtime-item">Nenhum equipamento em tr√¢nsito</div>'
                        : data.transitEquipments.slice(0, 5).map(equip => `
                            <div class="realtime-item">
                                <span>${equip.name}</span>
                                <span>${equip.duration}min ${this.getStatusDisplayName(equip.status)}</span>
                            </div>
                        `).join('');
                }

                // Indicadores de Performance
                document.getElementById('avgProductivity').textContent = data.avgProductivity + '%';
                document.getElementById('longestIdle').textContent = data.longestIdle + 'min';
                document.getElementById('equipmentInTransit').textContent = data.equipmentInTransit;
                document.getElementById('equipmentInMaintenance').textContent = data.equipmentInMaintenance;
            }

            // =============================================================================
            // CONFIGURA√á√ïES DA INTERFACE
            // =============================================================================
            buildConfigUI() {
                this.buildProductivityConfigUI();
                this.buildAlertConfigUI();
            }

            buildProductivityConfigUI() {
                const container = document.getElementById('productivityConfig');
                if (!container) return;

                const categories = [
                    { key: 'productive', title: '‚úÖ Status Produtivos', color: '#27ae60' },
                    { key: 'operational', title: 'üîÑ Status Operacionais', color: '#3498db' },
                    { key: 'idle', title: 'üî¥ Status Improdutivos', color: '#e74c3c' },
                    { key: 'nonComputable', title: '‚ö™ Status N√£o Comput√°veis', color: '#95a5a6' }
                ];

                container.innerHTML = categories.map(category => {
                    const statusList = this.productivityRules[category.key] || {};
                    
                    const statusItems = Object.entries(statusList).map(([status, config]) => `
                        <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${this.getStatusDisplayName(status)}</div>
                            <div style="font-size: 0.9rem; color: #5a6c7d; margin-bottom: 0.5rem;">${config.description || ''}</div>
                            
                            <div class="config-item">
                                <label>Aplicar para:</label>
                                <select id="equipment_${category.key}_${status}">
                                    <option value="all" ${config.equipments?.includes('all') ? 'selected' : ''}>Todos os Equipamentos</option>
                                    <option value="alta_pressao" ${config.equipments?.includes('alta_pressao') ? 'selected' : ''}>Alta Press√£o</option>
                                    <option value="auto_vacuo" ${config.equipments?.includes('auto_vacuo') ? 'selected' : ''}>Auto V√°cuo</option>
                                    <option value="hiper_vacuo" ${config.equipments?.includes('hiper_vacuo') ? 'selected' : ''}>Hiper V√°cuo</option>
                                </select>
                            </div>
                            
                            <div class="config-item">
                                <label>Prioridade (1-10):</label>
                                <input type="number" min="1" max="10" value="${config.priority || 5}" id="priority_${category.key}_${status}">
                            </div>
                            
                            ${config.alertLimit ? `
                                <div class="config-item">
                                    <label>Limite de Alerta (minutos):</label>
                                    <input type="number" min="1" max="600" value="${config.alertLimit}" id="alertLimit_${category.key}_${status}">
                                </div>
                            ` : ''}
                        </div>
                    `).join('');

                    return `
                        <div class="config-card" style="border-left: 4px solid ${category.color};">
                            <div class="config-title" style="color: ${category.color};">
                                ${category.title}
                            </div>
                            ${statusItems || '<div style="color: #7f8c8d; font-style: italic;">Nenhum status configurado</div>'}
                        </div>
                    `;
                }).join('');
            }

            buildAlertConfigUI() {
                const container = document.getElementById('alertConfig');
                if (!container) return;

                const alertStatuses = Object.entries(this.alertConfig).map(([status, config]) => `
                    <div class="config-card">
                        <div class="config-title">
                            üö® ${this.getStatusDisplayName(status)}
                        </div>
                        
                        <div class="config-item">
                            <label>Tempo Limite (minutos):</label>
                            <input type="number" min="1" max="600" value="${config.limit}" id="alert_limit_${status}">
                        </div>
                        
                        <div class="config-item">
                            <label>Aplicar para:</label>
                            <select id="alert_equipment_${status}">
                                <option value="all" ${config.equipment === 'all' ? 'selected' : ''}>Todos os Equipamentos</option>
                                <option value="alta_pressao" ${config.equipment === 'alta_pressao' ? 'selected' : ''}>Alta Press√£o</option>
                                <option value="auto_vacuo" ${config.equipment === 'auto_vacuo' ? 'selected' : ''}>Auto V√°cuo</option>
                                <option value="hiper_vacuo" ${config.equipment === 'hiper_vacuo' ? 'selected' : ''}>Hiper V√°cuo</option>
                            </select>
                        </div>
                        
                        <div class="config-checkbox">
                            <input type="checkbox" id="alert_active_${status}" ${config.active ? 'checked' : ''}>
                            <label for="alert_active_${status}">Ativo</label>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = alertStatuses;
            }

            // =============================================================================
            // FUN√á√ïES AUXILIARES
            // =============================================================================
            getEquipmentType(equipmentName) {
                const name = equipmentName.toUpperCase();
                if (name.includes('ALTA PRESS√ÉO') || name.includes('ALTA PRESSAO')) return 'alta_pressao';
                if (name.includes('AUTO V√ÅCUO') || name.includes('AUTO VACUO')) return 'auto_vacuo';
                if (name.includes('HIPER V√ÅCUO') || name.includes('HIPER VACUO')) return 'hiper_vacuo';
                return 'alta_pressao'; // Padr√£o
            }

            classifyStatusExact(status, equipmentType) {
                // Verificar em cada categoria
                for (const [category, statusList] of Object.entries(this.productivityRules)) {
                    if (statusList[status]) {
                        const config = statusList[status];
                        
                        // Verificar se aplica ao tipo de equipamento
                        if (config.equipments.includes('all') || config.equipments.includes(equipmentType)) {
                            return category.toUpperCase();
                        }
                    }
                }

                return 'IDLE'; // Padr√£o para improdutivo
            }

            getWorkingPeriodStatus(statusList) {
                if (!statusList || statusList.length === 0) return [];
                
                // Ordenar por data de in√≠cio
                const sortedStatus = [...statusList].sort((a, b) => 
                    new Date(a.start) - new Date(b.start)
                );
                
                // Encontrar o √∫ltimo not_appropriated
                let lastNotAppropriatedIndex = -1;
                for (let i = sortedStatus.length - 1; i >= 0; i--) {
                    if (sortedStatus[i].status === 'not_appropriated') {
                        lastNotAppropriatedIndex = i;
                        break;
                    }
                }
                
                // Retornar apenas status ap√≥s o √∫ltimo not_appropriated
                if (lastNotAppropriatedIndex >= 0) {
                    return sortedStatus.slice(lastNotAppropriatedIndex + 1);
                }
                
                return sortedStatus;
            }

            findCurrentActiveStatus(statusList, currentTime) {
                if (!statusList || statusList.length === 0) return null;
                
                // Ordenar por data de in√≠cio (mais recente primeiro)
                const sortedStatus = [...statusList].sort((a, b) => 
                    new Date(b.start) - new Date(a.start)
                );
                
                // Encontrar o status que est√° ativo no momento atual
                for (const status of sortedStatus) {
                    const startTime = new Date(status.start);
                    const endTime = status.end ? new Date(status.end) : null;
                    
                    if (startTime <= currentTime && (!endTime || endTime > currentTime)) {
                        return status;
                    }
                }
                
                return null;
            }

            calculateCurrentStatusDuration(status, currentTime) {
                try {
                    const startTime = new Date(status.start);
                    const durationMs = Math.max(0, currentTime - startTime);
                    const durationMinutes = Math.floor(durationMs / (1000 * 60));
                    
                    if (durationMinutes < 0 || durationMinutes > 10080) {
                        console.warn(`‚ö†Ô∏è Dura√ß√£o suspeita: ${durationMinutes}min para status ${status.status}`);
                        return 0;
                    }
                    
                    return durationMinutes;
                } catch (error) {
                    console.error('‚ùå Erro ao calcular dura√ß√£o do status:', error);
                    return 0;
                }
            }

            getDisplayName(equipName) {
                return equipName
                    .replace(/CAMINHAO/g, 'CAMINH√ÉO')
                    .replace(/VACUO/g, 'V√ÅCUO') 
                    .replace(/PRESSAO/g, 'PRESS√ÉO')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            getStatusDisplayName(status) {
                const names = {
                    'on': 'Motor Ligado',
                    'off': 'Motor Desligado',
                    'stopped': 'Parado',
                    'maintenance': 'Manuten√ß√£o',
                    'secondary_motor_on': 'Motor Secund√°rio',
                    'out_of_plant': 'Fora da Planta',
                    'not_appropriated': 'N√£o Apropriado',
                    'no_data': 'Sem Dados',
                    'running': 'Em Movimento'
                };
                return names[status] || status.charAt(0).toUpperCase() + status.slice(1);
            }

            normalizeEquipmentName(name) {
                if (!name) return 'Equipamento Desconhecido';
                
                let normalizedName = name.toUpperCase().trim();
                normalizedName = normalizedName.replace(/\s+/g, ' ');
                
                normalizedName = normalizedName
                    .replace(/\s*-\s*GPS\s*-\s*/g, ' - GPS - ')
                    .replace(/\s*-\s*(\d+)\s*HS\s*$/i, ' - $1HS')
                    .replace(/\s*-\s*(\d+)\s*H\s*$/i, ' - $1HS')
                    .replace(/CAMINH√ÉO/g, 'CAMINHAO')
                    .replace(/V√ÅCUO/g, 'VACUO')
                    .replace(/PRESS√ÉO/g, 'PRESSAO')
                    .trim();
                
                return normalizedName;
            }

            parseDate(dateStr) {
                if (!dateStr) return null;
                
                try {
                    // Tentar diferentes formatos
                    let date = new Date(dateStr);
                    
                    if (isNaN(date.getTime())) {
                        // Tentar formato brasileiro DD/MM/YYYY HH:mm:ss
                        const parts = dateStr.split(' ');
                        if (parts.length >= 2) {
                            const datePart = parts[0].split('/');
                            const timePart = parts[1];
                            
                            if (datePart.length === 3) {
                                const [day, month, year] = datePart;
                                date = new Date(`${year}-${month}-${day}T${timePart}`);
                            }
                        }
                    }
                    
                    return isNaN(date.getTime()) ? null : date;
                } catch (error) {
                    console.error('‚ùå Erro ao fazer parse da data:', dateStr, error);
                    return null;
                }
            }

            formatHours(hours) {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                if (h === 0) return `${m}min`;
                if (m === 0) return `${h}h`;
                return `${h}h ${m}min`;
            }

            updateSyncStatus(status, message) {
                const dot = document.getElementById('syncDot');
                const statusText = document.getElementById('syncStatus');
                
                if (dot) dot.className = `sync-dot ${status}`;
                if (statusText) statusText.textContent = message;
            }

            updateSystemInfo() {
                this.updateLastUpdateTime();
                
                setInterval(() => {
                    this.updateLastUpdateTime();
                }, 60000);
            }

            updateLastUpdateTime() {
                const lastUpdateTimeElement = document.getElementById('lastUpdateTime');
                if (lastUpdateTimeElement) {
                    lastUpdateTimeElement.textContent = new Date().toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }

            // =============================================================================
            // CONFIGURA√á√ïES DO GITHUB
            // =============================================================================
            async saveConfigToGitHub() {
                try {
                    console.log('üíæ Preparando configura√ß√µes para GitHub...');
                    
                    const config = {
                        productivityRules: this.productivityRules,
                        alertConfig: this.alertConfig,
                        lastUpdate: new Date().toISOString(),
                        version: '1.0.0'
                    };
                    
                    const configContent = JSON.stringify(config, null, 2);
                    
                    // Simular salvamento (em produ√ß√£o, precisaria de autentica√ß√£o)
                    console.log('üìù Configura√ß√µes preparadas para GitHub:', config);
                    this.showNotification('Configura√ß√µes preparadas (necess√°ria autentica√ß√£o GitHub para salvar)', 'info');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao preparar configura√ß√µes:', error);
                    this.showNotification('Erro ao preparar configura√ß√µes', 'error');
                }
            }

            saveAlertConfig() {
                // Coletar dados dos inputs de alerta
                Object.keys(this.alertConfig).forEach(status => {
                    const limitInput = document.getElementById(`alert_limit_${status}`);
                    const equipmentSelect = document.getElementById(`alert_equipment_${status}`);
                    const activeInput = document.getElementById(`alert_active_${status}`);
                    
                    if (limitInput) this.alertConfig[status].limit = parseInt(limitInput.value);
                    if (equipmentSelect) this.alertConfig[status].equipment = equipmentSelect.value;
                    if (activeInput) this.alertConfig[status].active = activeInput.checked;
                });
                
                this.showNotification('Configura√ß√µes de alertas salvas!', 'success');
            }

            exportAlerts() {
                const alertsData = {
                    activeAlerts: Array.from(this.activeAlerts.entries()),
                    alertHistory: this.alertHistory,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(alertsData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `alertas_produtividade_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                this.showNotification('Alertas exportados com sucesso!', 'success');
            }
        }

        // =============================================================================
        // INICIALIZA√á√ÉO GLOBAL
        // =============================================================================
        let productivitySystem = null;

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            productivitySystem = new ProductivitySystem();
            
            console.log('üéØ Sistema de Produtividade GrupoGPS carregado com sucesso!');
            console.log('üîÑ Sincroniza√ß√£o autom√°tica ativada com GitHub');
        });

        // Adicionar estilos para itens de apontamento
        const additionalStyles = `
            .vis-item.apontamento-item {
                background-color: rgba(52, 152, 219, 0.8) !important;
                border-color: #3498db !important;
                border-style: dashed !important;
            }
            
            .vis-item.consolidated-item::before {
                content: 'üîó';
                position: absolute;
                top: -5px;
                right: -5px;
                font-size: 10px;
                background: #27ae60;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                z-index: 10;
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
